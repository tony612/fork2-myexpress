// Generated by CoffeeScript 1.7.1
(function() {
  module.exports = function() {
    var domain, handler, http;
    http = require('http');
    domain = require('domain');
    handler = function(request, response, next) {
      var errorNext, findNearErrorStack, findNearNormalStack, index, normalNext, pIndex, pNext, parent, responseWith;
      if (handler.stack.length === 0) {
        parent = handler.parent;
        if (parent) {
          pIndex = parent.stack.indexOf(handler);
          pNext = parent.stack[pIndex + 1];
          pNext(request, response);
        } else {
          response.statusCode = 404;
          response.end();
          return;
        }
      }
      index = -1;
      findNearNormalStack = function(index) {
        var s, _i, _len, _ref;
        _ref = handler.stack.slice(index);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          s = _ref[_i];
          if (s.length < 4) {
            return s;
          }
        }
      };
      findNearErrorStack = function(index) {
        var s, _i, _len, _ref;
        _ref = handler.stack.slice(index);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          s = _ref[_i];
          if (s.length === 4) {
            return s;
          }
        }
      };
      responseWith = function(code) {
        response.statusCode = code;
        return response.end();
      };
      errorNext = function(err) {
        var nextStack;
        if (nextStack = findNearErrorStack(index)) {
          return nextStack(err, request, response, next);
        } else {
          parent = handler.parent;
          if (parent) {
            pIndex = parent.stack.indexOf(handler);
            pNext = parent.stack[pIndex + 1];
            return pNext(err, request, response);
          } else {
            return responseWith(500);
          }
        }
      };
      normalNext = function() {
        var e, nextStack;
        if (nextStack = findNearNormalStack(index)) {
          try {
            return nextStack(request, response, next);
          } catch (_error) {
            e = _error;
            return responseWith(500);
          }
        } else {
          return responseWith(404);
        }
      };
      next = function(err) {
        index += 1;
        if (err) {
          return errorNext(err);
        } else {
          return normalNext();
        }
      };
      return next();
    };
    handler.listen = function(port, callback) {
      return http.createServer(handler).listen(port, callback);
    };
    handler.stack = [];
    handler.use = function(middleware) {
      if (middleware.stack) {
        middleware.parent = handler;
      }
      return handler.stack.push(middleware);
    };
    return handler;
  };

}).call(this);
