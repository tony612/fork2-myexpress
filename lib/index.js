// Generated by CoffeeScript 1.7.1
(function() {
  module.exports = function() {
    var Layer, handler, http, mergeObjs;
    http = require('http');
    Layer = require('./layer');
    mergeObjs = function(obj1, obj2) {
      var k, obj3, v;
      obj3 = {};
      obj1 || (obj1 = {});
      obj2 || (obj2 = {});
      for (k in obj1) {
        v = obj1[k];
        obj3[k] = obj1[k];
      }
      for (k in obj2) {
        v = obj2[k];
        obj3[k] = obj2[k];
      }
      return obj3;
    };
    handler = function(request, response) {
      var errorEnd, errorNext, findNearErrorLayer, findNearNormalLayer, findParentNext, index, next, normalEnd, normalNext, responseWith;
      findParentNext = function(parent) {
        var pIndex, pNext;
        pIndex = parent.stack.indexOf(handler.wrap);
        return pNext = parent.stack[pIndex + 1];
      };
      responseWith = function(code) {
        response.statusCode = code;
        return response.end();
      };
      index = -1;
      findNearNormalLayer = function(index) {
        var l, match, _i, _len, _ref;
        _ref = handler.stack.slice(index);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          l = _ref[_i];
          if (l.handle.length < 4 && (match = l.match(request.url))) {
            request.params = mergeObjs(request.params, match.params);
            return l;
          }
        }
      };
      findNearErrorLayer = function(index) {
        var l, match, _i, _len, _ref;
        _ref = handler.stack.slice(index);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          l = _ref[_i];
          if (l.handle.length === 4 && (match = l.match(request.url))) {
            request.params = mergeObjs(request.params, match.params);
            return l;
          }
        }
      };
      normalEnd = function() {
        var pNext, parent;
        if ((parent = handler.parent) && (pNext = findParentNext(parent))) {
          return pNext.handle(request, response);
        } else {
          return responseWith(404);
        }
      };
      errorEnd = function(err) {
        var pNext, parent;
        if ((parent = handler.parent) && (pNext = findParentNext(parent))) {
          return pNext.handle(err, request, response);
        } else {
          return responseWith(500);
        }
      };
      normalNext = function() {
        var e, nextLayer;
        if (nextLayer = findNearNormalLayer(index)) {
          try {
            return nextLayer.handle(request, response, next);
          } catch (_error) {
            e = _error;
            return errorNext(e);
          }
        } else {
          return normalEnd();
        }
      };
      errorNext = function(err) {
        var nextLayer;
        if (nextLayer = findNearErrorLayer(index)) {
          return nextLayer.handle(err, request, response, next);
        } else {
          return errorEnd(err);
        }
      };
      next = function(err) {
        index += 1;
        if (err) {
          return errorNext(err);
        } else {
          return normalNext();
        }
      };
      return next();
    };
    handler.listen = function(port, callback) {
      return http.createServer(handler).listen(port, callback);
    };
    handler.stack = [];
    handler.use = function(path, middleware) {
      var layer, _ref;
      if (!middleware) {
        _ref = ['/', path], path = _ref[0], middleware = _ref[1];
      }
      layer = new Layer(path, middleware);
      if (middleware.stack) {
        middleware.parent = handler;
        middleware.wrap = layer;
      }
      return handler.stack.push(layer);
    };
    return handler;
  };

}).call(this);
